<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UK Air Pollution/Emissions Data Explorer</title>
  <link rel="icon" type="image/png" sizes="64x64" href="SharedResources/images/favicon.png">
  <link rel="apple-touch-icon" href="SharedResources/images/favicon.png">

  <!-- Social preview / link preview meta tags -->
  <meta name="description" content="Interactive charts using UK Government data"> 
  <!-- Open Graph (Facebook, LinkedIn, Slack, etc.) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="UK Air Pollution/Emissions Data Explorer">
  <meta property="og:description" content="Interactive charts using UK Government data">
  <meta property="og:url" content="https://chronicillnesschannel.co.uk/uk-air-pollution-emissions-data-explorer/">
  <meta property="og:image" content="SharedResources/images/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">
  <meta property="og:image:width" content="1120">
  <meta property="og:image:height" content="630">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="UK Air Pollution/Emissions Data Explorer">
  <meta name="twitter:description" content="Interactive charts using UK Government data">
  <meta name="twitter:image" content="SharedResources/images/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">
  <meta name="robots" content="noindex, nofollow">
  <meta name="twitter:site" content="@Chronic_Channel">
  <meta name="twitter:creator" content="@Chronic_Channel">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script>
    (function primeScrollRestoration() {
      try {
        var params = new URLSearchParams(window.location.search || '');
        var tutorialRequested = params.has('bubbletutorial') || params.has('bubbleTutorial');
        if (tutorialRequested && window.history && 'scrollRestoration' in window.history) {
          window.history.scrollRestoration = 'manual';
          window.__NAEI_SCROLL_RESTORED_MANUALLY__ = true;
        }
      } catch (error) {
        if (window && window.console && window.console.warn) {
          window.console.warn('Unable to prime scroll restoration:', error);
        }
      }
    })();
  </script>
  
  <!-- Load Supabase and shared resources -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="SharedResources/supabase-env.js"></script>
  <script src="SharedResources/supabase-config.js"></script>
  <!-- Shared Data Loader -->
  <script src="SharedResources/shared-data-loader.js"></script>
  
  <!-- Google Charts for charting -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  
  <!-- XLSX for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Inter font via Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  
  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="dist/tailwind.css">
  <style>
    /* Chart interface - no transition needed, overlay fade handles visibility */
    
    /* Chart containers render immediately; parent overlay handles fade */
    .chart-container {
      opacity: 1;
      transition: none;
      padding: 0;
    }
    
    .chart-container.ready {
      opacity: 1;
    }

    /* Full-screen loading overlay */
    #main-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 10000;
      display: block;
      box-sizing: border-box;
      padding: 0 1.5rem;
      transition: opacity 0.5s ease;
    }
    
    #main-loading-overlay .main-loading-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 20px;
      width: 100%;
      max-width: 360px;
    }
    
    #main-loading-overlay .main-spinner {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: conic-gradient(#E6194B 0deg 120deg, #F58231 120deg 240deg, #FFE119 240deg 360deg);
      animation: spin 1.25s linear infinite;
      margin: 0;
    }
    
    #main-loading-overlay .main-loading-text {
      color: #374151;
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
  #chart_div {
      width: 100%;
      min-height: 400px;
    }
    
    .spinner {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: conic-gradient(#E6194B 0deg 120deg, #F58231 120deg 240deg, #FFE119 240deg 360deg);
      animation: spin 1.25s linear infinite;
      box-shadow: 0 0 12px rgba(0,0,0,0.08);
      outline: none;
      border: none;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Sidebar Social Media Styles (from chart v2.4) */
    #cicLogo {
      width: 110px;
      height: auto;
      display: block;
    }

    .sidebar-socials {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 100;
    }

    .sidebar-icons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }

    .sidebar-link {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
    }

    .sidebar-link img {
      display: block;
      height: 40px;
      width: 40px;
      object-fit: contain;
    }

    .tab-active {
      color: #FF9301;
      border-bottom-color: #FF9301;
    }

    .tab-active:hover {
      color: #FF9301;
      border-bottom-color: #FF9301;
    }

    /* Brand link styling */
    :root {
      --brand-link-color: #FF9301;
      --brand-link-hover: #cc7500;
    }

    a[href]:not(.kofi-button),
    a[href]:not(.kofi-button):visited {
      color: var(--brand-link-color);
      transition: color 0.2s ease-in-out;
    }

    a[href]:not(.kofi-button):hover,
    a[href]:not(.kofi-button):focus-visible,
    a[href]:not(.kofi-button):active {
      color: var(--brand-link-hover);
    }

    .kofi-button,
    .kofi-button:visited,
    .kofi-button:hover,
    .kofi-button:focus-visible {
      color: #ffffff;
    }

    .kofi-button .kofi-text {
      color: inherit;
    }

    a[href*="facebook.com"] img {
      width: 36px;
      height: 36px;
    }

    .kofi-wrapper {
      width: 40px;
      height: 40px;
      position: relative;
      margin-top: 13px;
    }

    .kofi-button {
      display: flex;
      flex-direction: row-reverse;
      align-items: center;
      background-color: #ff9301;
      border-radius: 8px;
      height: 40px;
      color: white;
      text-decoration: none;
      overflow: hidden;
      position: absolute;
      top: 0;
      right: 0;
      width: 40px;
      transition: width 0.4s ease-in-out;
    }

    .kofi-wrapper:hover .kofi-button {
      width: 295px;
    }

    .kofi-icon-svg {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      min-width: 40px;
      flex-shrink: 0;
    }

    .kofi-text {
      white-space: nowrap;
      padding-right: 0px;
      padding-left: 0px; 
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease-in-out 0.1s;
    }

    .kofi-wrapper:hover .kofi-text {
      opacity: 1;
    }

    .opera-browser .kofi-wrapper:hover .kofi-button {
      width: 295px;
    }

    .header-bar {
      min-height: 4rem;
      height: auto;
      flex-wrap: wrap;
      row-gap: 4px;
      align-items: flex-start;
      padding-top: 6px;
    }

    .page-title {
      line-height: 1.2;
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 7px;
      padding-right: 130px;
    }

    .tab-nav {
      padding-right: 0;
    }

    .tab-bar {
      position: relative;
      padding-right: 130px;
    }

    .tab-bar::after {
      content: '';
      position: absolute;
      left: 0;
      right: 130px;
      bottom: 0;
      border-bottom: 1px solid #e5e7eb;
      pointer-events: none;
    }

    .page-title-word {
      display: inline-flex;
      white-space: nowrap;
    }

    .page-title-word--chunk {
      gap: 7px;
    }

    @media (max-width: 620px) {
      .page-title {
        padding-right: 0;
      }

      .tab-nav {
        padding-right: 0;
      }

      .tab-bar {
        padding-right: 0;
      }

      .tab-bar::after {
        right: 0;
      }
    }

    html.mobile-device .page-title,
    html.mobile-device .tab-nav,
    html.mobile-device .tab-bar {
      padding-right: 0;
    }

    html.mobile-device .tab-bar::after {
      right: 0;
    }

    nav[role="tablist"] button:focus,
    nav[role="tablist"] button:focus-visible,
    nav[role="tablist"] button:focus-within {
      outline: none;
      box-shadow: none;
    }

    @supports (-webkit-appearance: none) {
      .kofi-button .kofi-text {
        font-size: 16px;
      }
    }
    
    /* Mobile responsive styles */
    @media (max-width: 620px) {
      .sidebar-socials {
        position: static;
        width: 100%;
        flex-direction: row;
        align-items: flex-start;
        margin: 16px 20px;
        gap: 12px;
        top: auto;
        right: auto;
      }

      #cicLogo {
        width: 90px;
      }

      .sidebar-icons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 8px;
        margin-top: 0;
        width: auto;
      }
      
      .kofi-wrapper {
        margin-top: 0;
        margin-left: 0px;
        align-self: flex-start;
        width: 35px;
        height: 35px;
      }
      
      .kofi-button, .kofi-icon-svg {
        height: 35px;
      }
      
      .kofi-button {
        width: 35px;
        transition: none;
      }
      
      .kofi-wrapper:hover .kofi-button {
        width: 35px;
      }
      
      .kofi-wrapper:hover .kofi-text {
        opacity: 0;
      }
    
      .kofi-button img {
        position: relative;
        transform: translateX(3px);
      }

      .sidebar-link {
        width: 35px;
        height: 35px;
        margin-bottom: 0;
      }

      .sidebar-link img {
        width: 35px;
        height: 35px;
      }

      a[href*="facebook.com"] img {
        width: 32px;
        height: 32px;
      }
    }

    html.mobile-device .sidebar-socials {
      position: static;
      width: 100%;
      flex-direction: row;
      align-items: flex-start;
      margin: 16px 20px;
      gap: 12px;
      top: auto;
      right: auto;
    }

    html.mobile-device #cicLogo {
      width: 90px;
    }

    html.mobile-device .sidebar-icons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 8px;
      margin-top: 0;
      width: auto;
    }

    html.mobile-device .kofi-wrapper {
      margin-top: 0;
      margin-left: 0;
      align-self: flex-start;
      width: 35px;
      height: 35px;
    }

    html.mobile-device .kofi-button,
    html.mobile-device .kofi-icon-svg {
      height: 35px;
    }

    html.mobile-device .kofi-button {
      width: 35px;
      transition: none;
    }

    html.mobile-device .kofi-wrapper:hover .kofi-button {
      width: 35px;
    }

    html.mobile-device .kofi-wrapper:hover .kofi-text {
      opacity: 0;
    }

    html.mobile-device .kofi-button img {
      position: relative;
      transform: translateX(3px);
    }

    html.mobile-device .sidebar-link {
      width: 35px;
      height: 35px;
      margin-bottom: 0;
    }

    html.mobile-device .sidebar-link img {
      width: 35px;
      height: 35px;
    }

    html.mobile-device a[href*="facebook.com"] img {
      width: 32px;
      height: 32px;
    }

    .remove-group-btn,
    .add-group-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .remove-group-btn img,
    .add-group-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .category-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }

    .category-info img {
      width: 24px;
      height: 24px;
    }

    html,
    body {
      height: 100%;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page-stack {
      flex: 1 0 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #chart-interface {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #mainFooter {
      margin-top: auto;
      flex-shrink: 0;
    }
  </style>
</head>

<body data-page-slug="home">

  <script>
    (function bootstrapIframeMessageQueue() {
      const queue = [];
      function enqueue(event) {
        if (typeof window.__NAEI_processIframeMessage === 'function') {
          try {
            window.__NAEI_processIframeMessage(event);
          } catch (error) {
            console.warn('Queued iframe message failed:', error);
          }
        } else {
          queue.push(event);
        }
      }

      window.__NAEI_messageQueue = queue;
      window.__NAEI_iframeMessageBridge = enqueue;
      window.addEventListener('message', enqueue, false);
    })();
  </script>

  <script>
    (function initMobileExperienceDetection() {
      const root = document.documentElement;
      let lastState = null;

      function computeMobileState() {
        try {
          const pointerCoarse = window.matchMedia && window.matchMedia('(pointer:coarse)').matches;
          const maxTouchPoints = navigator.maxTouchPoints || 0;
          const ua = navigator.userAgent || '';
          const uaMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobi/i.test(ua);
          const narrowViewport = Math.min(window.innerWidth || 0, window.innerHeight || 0) <= 900;
          if (uaMobile) {
            return true;
          }
          if ((pointerCoarse || maxTouchPoints > 1) && narrowViewport) {
            return true;
          }
        } catch (error) {
          /* noop */
        }
        return false;
      }

      function applyMobileSpacing(isMobile) {
        const pageTitle = document.querySelector('.page-title');
        const tabNav = document.querySelector('.tab-nav');
        if (pageTitle) {
          if (isMobile) {
            pageTitle.style.paddingRight = '0px';
          } else {
            pageTitle.style.paddingRight = '';
          }
        }
        if (tabNav) {
          if (isMobile) {
            tabNav.style.paddingRight = '0px';
          } else {
            tabNav.style.paddingRight = '';
          }
        }
      }

      function applyMobileState() {
        const isMobile = computeMobileState();
        if (isMobile === lastState) {
          return;
        }
        lastState = isMobile;
        window.__NAEI_IS_MOBILE_DEVICE__ = isMobile;
        if (isMobile) {
          root.classList.add('mobile-device');
        } else {
          root.classList.remove('mobile-device');
        }
        applyMobileSpacing(isMobile);
      }

      applyMobileState();

      let resizeTimer = null;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          applyMobileState();
        }, 150);
      });
      window.addEventListener('orientationchange', applyMobileState);

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => applyMobileSpacing(window.__NAEI_IS_MOBILE_DEVICE__));
      } else {
        applyMobileSpacing(window.__NAEI_IS_MOBILE_DEVICE__);
      }
    })();
  </script>

  <!-- Full-screen loading overlay -->
  <div id="main-loading-overlay">
    <div class="main-loading-content">
      <div class="main-spinner"></div>
      <div class="main-loading-text">Loading data, please wait...</div>
    </div>
  </div>

  <!-- CIC Logo and Social Media Sidebar -->
  <div class="sidebar-socials">
    <a href="https://chronicillnesschannel.co.uk" target="_blank">
      <img id="cicLogo" src="SharedResources/images/CIC-Square-Border-Words-Alpha.svg" alt="CIC Logo">
    </a>
    <div class="sidebar-icons">
      <a href="https://youtube.com/@chroniillnesschannel" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/youtube-logo-6.svg" alt="YouTube">
      </a>
      <a href="https://bsky.app/profile/chronicchannel.bsky.social" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/Bluesky_Logo.svg" alt="Bluesky">
      </a>
      <a href="https://twitter.com/chronic_channel" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/Twitter-dead-bird-X-220x206.svg" alt="Twitter/X">
      </a>
      <a href="https://facebook.com/chronicillnesschannel" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/facebook.svg" alt="Facebook">
      </a>
    </div>
    <div class="kofi-wrapper">
      <a href="https://ko-fi.com/chronicillnesschannel" target="_blank" class="kofi-button">
        <span class="kofi-icon-svg">
          <img src="SharedResources/images/kofi_symbol.svg" alt="Ko-fi" style="width: 28px; height: 28px; display: block; object-fit: contain;">
        </span>
        <span class="kofi-text">Support Chronic Illness Channel</span>
      </a>
    </div>
  </div>

  <div class="page-stack">
  <!-- Header -->
  <div class="bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between header-bar">
        <div class="flex items-center">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 page-title">
              <span class="page-title-word">UK Air</span>
              <span class="page-title-word">Pollution/Emissions<wbr></span>
              <span class="page-title-word page-title-word--chunk">
                <span>Data Explorer</span>
              </span>
            </h1>
            <p class="text-sm text-gray-500">Interactive Charts using UK Government Data</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="chart-interface" style="opacity: 0; margin: 0;">
    <!-- Tab Navigation -->
    <div class="bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="tab-bar">
          <nav class="tab-nav -mb-px flex flex-wrap items-center gap-6" role="tablist" aria-label="Chart views">
            <button type="button" id="tab-bubblechart" data-chart="bubblechart" onclick="switchChart('bubblechart')" role="tab" aria-controls="chart-bubblechart" aria-selected="true" tabindex="0" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/Bubble-Chart-Icon4.png" alt="Bubble chart icon" class="w-auto" style="height: 37px;">
              <span>Bubble Chart</span>
            </button>
            <button type="button" id="tab-linechart" data-chart="linechart" onclick="switchChart('linechart')" role="tab" aria-controls="chart-linechart" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/Line-Chart-Icon7.png" alt="Line chart icon" class="w-auto" style="height: 37px;">
              <span>Line Chart</span>
            </button>
            <button type="button" id="tab-category-info" data-chart="category-info" onclick="switchChart('category-info')" role="tab" aria-controls="chart-category-info" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/Group-Info-Icon.png" alt="Category info icon" class="h-8 w-auto" style="height: 37px;">
              <span>Category Info</span>
            </button>
            <button type="button" id="tab-user-guide" data-chart="user-guide" onclick="switchChart('user-guide')" role="tab" aria-controls="chart-user-guide" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/instructions-alpha-v4.png" alt="User guide icon" class="w-auto" style="height: 37px;">
              <span>User Guide</span>
            </button>
            <button type="button" id="tab-resources" data-chart="resources" onclick="switchChart('resources')" role="tab" aria-controls="chart-resources" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/chain-link-icon-CIC.png" alt="Resources icon" class="h-8 w-auto" style="height: 37px;">
              <span>Resources</span>
            </button>
          </nav>
        </div>
      </div>
    </div>

    <!-- Bubble Chart Container -->
  <div id="chart-bubblechart" class="chart-container" role="tabpanel" aria-labelledby="tab-bubblechart" aria-hidden="false">
      <iframe
        id="bubblechart-iframe"
        class="chart-iframe"
        src="bubblechart/embed.html"
        frameborder="0"
        scrolling="no"
        style="height: 600px;"
        title="NAEI Activity Data Bubble Chart"></iframe>
    </div>

    <!-- Line Chart Container -->
  <div id="chart-linechart" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-linechart" aria-hidden="true">
      <iframe
        id="linechart-iframe"
        class="chart-iframe"
        src="linechart/embed.html"
        frameborder="0"
        scrolling="no"
        style="height: 600px;"
        title="NAEI Activity Data Line Chart"></iframe>
    </div>

    <!-- Category Info Container -->
  <div id="chart-category-info" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-category-info" aria-hidden="true">
      <iframe
        id="categoryinfo-iframe"
        class="chart-iframe lazy-iframe"
        data-src="category-info/embed.html"
        loading="lazy"
        frameborder="0"
        scrolling="no"
        style="height: 900px;"
        title="NAEI Category Information"></iframe>
    </div>

    <!-- User Guide Container -->
  <div id="chart-user-guide" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-user-guide" aria-hidden="true">
      <iframe
        id="userguide-iframe"
        class="chart-iframe lazy-iframe"
        data-src="user-guide/embed.html"
        loading="lazy"
        frameborder="0"
        scrolling="no"
        style="height: 900px;"
        title="NAEI User Guide"></iframe>
    </div>

    <!-- Resources Container -->
  <div id="chart-resources" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-resources" aria-hidden="true">
      <iframe
        id="resources-iframe"
        class="chart-iframe lazy-iframe"
        data-src="resources/embed.html"
        loading="lazy"
        frameborder="0"
        scrolling="no"
        style="height: 900px;"
        title="NAEI Resources"></iframe>
    </div>

  </div> <!-- End chart-interface -->
  </div> <!-- End page-stack -->

  <!-- Footer (now outside chart-interface to keep spacing consistent across tall embeds) -->
  <footer class="bg-gray-50 border-t border-gray-200 py-1 px-4 text-center text-sm text-gray-700" id="mainFooter" style="margin-top: 0; opacity: 1;">
      <span class="footer-copyright">© Crown 2025 copyright Defra &amp; DESNZ<span class="footer-break" aria-hidden="true"> </span> via
      <a href="https://naei.energysecurity.gov.uk" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">naei.energysecurity.gov.uk</a></span>
      <span class="footer-license">licensed under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">Open Government Licence (OGL)</a>.</span>
      <br>
      <strong>YouTube:</strong> <a href="https://www.youtube.com/@ChronicIllnessChannel" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">www.youtube.com/@ChronicIllnessChannel</a><span class="footer-break" aria-hidden="true"> </span>
    <strong>Contact:</strong> <a  href="mailto:info@chronicillnesschannel.co.uk" target="_blank" rel="noopener" class="text-blue-600hover:text-blue-800">info@chronicillnesschannel.co.uk</a>
      <br>
      <span style="font-size: 0.8em; color: #666; margin-top: 4px; display: inline-block;">
        Explorer Version: v4.2 CIC-testdb (Line: v2.4, Bubble: v3.0)<span class="footer-break" aria-hidden="true"> </span> • Build: 2025.12.14
      </span>
    </footer>

  <style>
    .chart-iframe {
      width: 100%;
      max-width: 100%;
      border: none;
      background: white;
      display: block;
      overflow: hidden;
    }

    .footer-copyright,
    .footer-license {
      white-space: nowrap;
    }
    
    @media (max-width: 900px) {
      .footer-copyright {
        display: block;
      }
    }

    .footer-break {
      display: inline;
    }

    @media (max-width: 768px) {
      .footer-break {
        display: block;
        width: 100%;
        height: 0;
      }
    }
  </style>

  <script>
    (function() {
      var redirect = sessionStorage.redirect;
      delete sessionStorage.redirect;
      if (redirect && redirect != location.href) {
        history.replaceState(null, null, redirect);
      }
    })();

    // Chart routing system with tabbed interface
    let currentChart = null;
    const globalUrlParams = new URLSearchParams(window.location.search || '');
    const debugLoggingEnabled = ['debug', 'logs', 'debugLogs'].some(flag => globalUrlParams.has(flag));
    const debugWarn = (...args) => {
      if (debugLoggingEnabled) {
        console.warn(...args);
      }
    };
    window.__NAEI_DEBUG__ = debugLoggingEnabled;

    if (!debugLoggingEnabled) {
      console.log = () => {};
      console.info = () => {};
      if (console.debug) {
        console.debug = () => {};
      }
    }
    
    const STATIC_CHART_IDS = new Set(['category-info', 'user-guide', 'resources']);
    const ALL_CHART_IDS = new Set(['bubblechart', 'linechart', ...STATIC_CHART_IDS]);
    const CHART_SEQUENCE = ['bubblechart', 'linechart', 'category-info', 'user-guide', 'resources'];
    const TAB_ID_MAP = {
      'bubblechart': 'tab-bubblechart',
      'linechart': 'tab-linechart',
      'category-info': 'tab-category-info',
      'user-guide': 'tab-user-guide',
      'resources': 'tab-resources'
    };


    // Store last known state for each chart (populated by messages from iframes)
    const chartStates = {
      'bubblechart': [],            // Bubble chart state
      'linechart': [],            // Line chart state
      'category-info': [],   // Category info view (static)
      'user-guide': [],   // User guide view (static)
      'resources': []     // Resources view (static)
    };

    const bubbleTutorialParamPresent = ['bubbletutorial', 'bubbleTutorial'].some(param => globalUrlParams.has(param));
    const bubbleTutorialControl = {
      requested: bubbleTutorialParamPresent,
      active: bubbleTutorialParamPresent,
      openRequestSent: false
    };

    const reloadNavigationDetected = detectReloadNavigation();
    if (reloadNavigationDetected) {
      bubbleTutorialControl.requested = false;
      bubbleTutorialControl.active = false;
      bubbleTutorialControl.openRequestSent = false;
      if (bubbleTutorialParamPresent) {
        removeBubbleTutorialFlagFromUrl();
      }
    }

    if (typeof window !== 'undefined' && window.history && 'scrollRestoration' in window.history) {
      window.history.scrollRestoration = bubbleTutorialControl.requested ? 'manual' : 'auto';
    }

    enforceBubbleTutorialScrollReset();

    function detectReloadNavigation() {
      try {
        if (typeof performance !== 'undefined') {
          if (typeof performance.getEntriesByType === 'function') {
            const entries = performance.getEntriesByType('navigation');
            if (entries && entries.length) {
              return entries[entries.length - 1].type === 'reload';
            }
          }
          if (performance.navigation && typeof performance.navigation.type === 'number') {
            return performance.navigation.type === performance.navigation.TYPE_RELOAD;
          }
        }
      } catch (error) {
        debugWarn('Unable to determine navigation type:', error);
      }
      return false;
    }

    function enforceBubbleTutorialScrollReset() {
      if (!bubbleTutorialControl.requested || typeof window === 'undefined' || typeof window.scrollTo !== 'function') {
        return;
      }

      const runResetSequence = () => {
        let attempts = 0;
        const maxAttempts = 3;
        const raf = window.requestAnimationFrame || function(cb) { return window.setTimeout(cb, 0); };

        const tick = () => {
          attempts += 1;
          try {
            window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
            if (document.documentElement) {
              document.documentElement.scrollTop = 0;
            }
            if (document.body) {
              document.body.scrollTop = 0;
            }
          } catch (error) {
            debugWarn('Unable to reset scroll position for bubble tutorial:', error);
          }

          if (attempts < maxAttempts) {
            raf(tick);
          }
        };

        tick();
      };

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        runResetSequence();
      } else {
        document.addEventListener('DOMContentLoaded', runResetSequence, { once: true });
      }
    }
    
    // Load shared resources
    window.addEventListener('DOMContentLoaded', function() {
      // Load shared analytics, colors, and configuration
      loadScript('SharedResources/analytics.js');
      loadScript('SharedResources/colors.js');
    });
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    const chartReadyState = {
      bubblechart: false,
      linechart: false,
      'category-info': false
    };
    const BASE_REQUIRED_CHART_KEYS = ['bubblechart', 'linechart'];
    let overlayRequiredChartKeys = [...BASE_REQUIRED_CHART_KEYS];
    let sharedDataBootstrapLaunched = false;

    function requestSharedDataBootstrap(reason = 'chart-ready') {
      if (sharedDataBootstrapLaunched) {
        return;
      }
      sharedDataBootstrapLaunched = true;
      setTimeout(() => {
        try {
          window.SharedDataLoader?.loadSharedData?.().catch(error => {
            console.warn('Background shared data load failed:', error);
          });
        } catch (error) {
          console.warn('Unable to launch background shared data load:', error, 'reason:', reason);
        }
      }, 50);
    }

    const iframeElements = {
      bubblechart: document.getElementById('bubblechart-iframe'),
      linechart: document.getElementById('linechart-iframe'),
      'category-info': document.getElementById('categoryinfo-iframe'),
      'user-guide': document.getElementById('userguide-iframe'),
      resources: document.getElementById('resources-iframe')
    };

    function notifyIframeVisibility(chartId, isVisible) {
      const iframe = iframeElements[chartId];
      if (!iframe || !iframe.contentWindow) {
        return;
      }
      try {
        iframe.contentWindow.postMessage({
          type: 'chartVisibility',
          chartId,
          visible: Boolean(isVisible)
        }, '*');
      } catch (error) {
        debugWarn('Unable to post visibility message to', chartId, error);
      }
    }

    function setOverlayRequiredCharts(initialChartId) {
      const normalized = normalizeChartId(initialChartId) || 'bubblechart';
      overlayRequiredChartKeys = [...BASE_REQUIRED_CHART_KEYS];
      if (!overlayRequiredChartKeys.includes(normalized)) {
        overlayRequiredChartKeys.push(normalized);
      }
      if (normalized === 'category-info' && !overlayRequiredChartKeys.includes('category-info')) {
        overlayRequiredChartKeys.push('category-info');
      }
    }

    function decomposeUrl(rawUrl) {
      if (typeof rawUrl !== 'string' || !rawUrl.length) {
        return { origin: '', base: '', query: '', hash: '' };
      }

      let working = rawUrl;
      let origin = '';

      const absoluteUrlPattern = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//;
      if (absoluteUrlPattern.test(rawUrl)) {
        try {
          const parsed = new URL(rawUrl);
          origin = `${parsed.protocol}//${parsed.host}`;
          working = parsed.pathname + parsed.search + parsed.hash;
        } catch (error) {
          debugWarn('Unable to parse absolute URL:', error);
        }
      }

      const hashIndex = working.indexOf('#');
      const hash = hashIndex >= 0 ? working.slice(hashIndex) : '';
      const withoutHash = hashIndex >= 0 ? working.slice(0, hashIndex) : working;

      const queryIndex = withoutHash.indexOf('?');
      const base = queryIndex >= 0 ? withoutHash.slice(0, queryIndex) : withoutHash;
      const query = queryIndex >= 0 ? withoutHash.slice(queryIndex + 1) : '';

      return { origin, base, query, hash };
    }

    function humanizeUrlEncoding(value) {
      if (typeof value !== 'string' || !value.length) {
        return value || '';
      }
      return value.replace(/%2C/gi, ',');
    }

    function rebuildUrl({ origin = '', base = '', query = '', hash = '' }) {
      const queryPart = query ? `?${query}` : '';
      const assembled = `${origin}${base}${queryPart}${hash}`;
      return humanizeUrlEncoding(assembled);
    }

    function inferChartIdFromBasePath(basePath) {
      if (typeof basePath !== 'string' || !basePath.length) {
        return null;
      }

      try {
        const segments = basePath.split('/').filter(Boolean);
        if (!segments.length) {
          return null;
        }

        const normalizeSegment = (value) => value.replace(/\.html?$/, '').toLowerCase();
        let candidate = normalizeSegment(segments[segments.length - 1]);

        if (STATIC_CHART_IDS.has(candidate) || candidate === 'bubblechart' || candidate === 'linechart') {
          return candidate;
        }

        if (candidate === 'index' && segments.length > 1) {
          candidate = normalizeSegment(segments[segments.length - 2]);
          if (STATIC_CHART_IDS.has(candidate) || candidate === 'bubblechart' || candidate === 'linechart') {
            return candidate;
          }
        }
      } catch (error) {
        debugWarn('Unable to infer chart from base path:', error);
      }

      return null;
    }

    function applyBubbleTutorialFlag(url) {
      if (!url) {
        return url;
      }

      const components = decomposeUrl(url);
      const params = new URLSearchParams(components.query || '');
      const normalizedPage = normalizeChartId(params.get('page'));
      const legacyChart = normalizeChartId(params.get('chart'));
      const inferredChart = inferChartIdFromBasePath(components.base);
      const targetChart = normalizedPage || legacyChart || inferredChart || 'bubblechart';
      if (!normalizedPage && !inferredChart && targetChart) {
        params.set('page', targetChart);
      }
      params.delete('chart');

      const shouldIncludeFlag = bubbleTutorialControl.active && targetChart === 'bubblechart';

      if (shouldIncludeFlag) {
        if (!params.has('bubbletutorial')) {
          params.append('bubbletutorial', '1');
        }
      } else {
        params.delete('bubbletutorial');
        params.delete('bubbleTutorial');
      }

      components.query = params.toString();
      return rebuildUrl(components);
    }

    function updateHistoryState(method, targetUrl) {
      const finalUrl = applyBubbleTutorialFlag(targetUrl);
      const stateData = { path: finalUrl };
      try {
        window.history[method](stateData, '', finalUrl);
      } catch (error) {
        debugWarn(`Unable to update history via ${method}:`, error);
      }
    }

    function removeBubbleTutorialFlagFromUrl() {
      try {
        const currentUrl = window.location.pathname + window.location.search + window.location.hash;
        const components = decomposeUrl(currentUrl);
        const params = components.query
          ? components.query.split('&').filter(Boolean)
          : [];
        const filtered = params.filter(param => {
          const [key] = param.split('=');
          return key && key.toLowerCase() !== 'bubbletutorial';
        });
        components.query = filtered.join('&');
        const cleanUrl = rebuildUrl(components);
        window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
      } catch (error) {
        debugWarn('Unable to remove bubbletutorial flag from URL:', error);
      }
    }

    function attemptBubbleTutorialAutoOpen() {
      if (!bubbleTutorialControl.requested || bubbleTutorialControl.openRequestSent) {
        return;
      }

      const iframe = iframeElements.bubblechart;
      if (!iframe || !iframe.contentWindow) {
        return;
      }

      try {
        iframe.contentWindow.postMessage({
          type: 'openBubbleTutorial',
          reason: 'url-param'
        }, '*');
        bubbleTutorialControl.openRequestSent = true;
      } catch (error) {
        debugWarn('Unable to request bubble tutorial overlay:', error);
      }
    }

    let cachedParentFooterHeight = 0;
    let cachedViewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;

    function getParentFooterHeight() {
      const footerEl = document.getElementById('mainFooter');
      if (!footerEl) {
        cachedParentFooterHeight = 0;
        return 0;
      }
      const rect = footerEl.getBoundingClientRect();
      cachedParentFooterHeight = Math.round(rect.height || 0);
      return cachedParentFooterHeight;
    }

    function broadcastViewportMetrics(targetKeys) {
      const keys = Array.isArray(targetKeys)
        ? targetKeys
        : (targetKeys ? [targetKeys] : ['bubblechart', 'linechart', 'user-guide']);
      const normalizedKeys = keys.map(key => normalizeChartId(key) || key);

      const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
      if (viewportHeight) {
        cachedViewportHeight = viewportHeight;
      }

      normalizedKeys.forEach(key => {
        const iframe = iframeElements[key];
        if (!iframe || !iframe.contentWindow) {
          return;
        }
        iframe.contentWindow.postMessage({
          type: 'parentViewportMetrics',
          viewportHeight: cachedViewportHeight,
          footerHeight: cachedParentFooterHeight
        }, '*');
      });
    }

    window.addEventListener('resize', () => {
      getParentFooterHeight();
      broadcastViewportMetrics();
    });
    window.addEventListener('resize', () => {
      getParentFooterHeight();
      ['bubblechart', 'user-guide'].forEach(key => {
        const iframe = iframeElements[key];
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({
            type: 'parentFooterHeight',
            value: cachedParentFooterHeight
          }, '*');
        }
      });
    });

    window.addEventListener('load', () => {
      getParentFooterHeight();
      broadcastViewportMetrics();
      prepaintSupplementalCharts();
    });

    if (debugLoggingEnabled) {
      Object.values(iframeElements).forEach(iframe => {
        if (!iframe) {
          return;
        }

        try {
          const currentSrcAttr = iframe.getAttribute('src');
          const effectiveSrc = currentSrcAttr || iframe.dataset.src;
          if (!effectiveSrc) {
            return;
          }

          const iframeUrl = new URL(effectiveSrc, window.location.href);
          if (!iframeUrl.searchParams.has('debug')) {
            iframeUrl.searchParams.set('debug', '1');
            if (currentSrcAttr) {
              iframe.src = iframeUrl.toString();
            } else {
              iframe.dataset.src = iframeUrl.toString();
            }
          }
        } catch (error) {
          debugWarn('Unable to append debug flag to iframe source', error);
        }
      });
    }

    function areAllChartsReady() {
      return overlayRequiredChartKeys.every(key => chartReadyState[key]);
    }

    function areRequiredHeightsReady() {
      return overlayRequiredChartKeys.every(key => Boolean(heightsReceived[key]));
    }

    function maybeHideOverlay() {
      if (overlayHidden) {
        return;
      }
      if (!areAllChartsReady() || !areRequiredHeightsReady()) {
        return;
      }
      setTimeout(() => {
        if (!overlayHidden) {
          window.hideLoadingOverlay();
        }
      }, 50);
    }

    function resolveChartFromPath() {
      try {
        const segments = (window.location.pathname || '').split('/').filter(Boolean);
        if (!segments.length) {
          return null;
        }

        const normalizeSegment = (value) => (value || '').toLowerCase().replace(/\.html?$/, '');
        const inspectSegment = (segment) => {
          const normalized = normalizeChartId(normalizeSegment(segment));
          if (normalized && ALL_CHART_IDS.has(normalized)) {
            return normalized;
          }
          return null;
        };

        const lastSegment = inspectSegment(segments[segments.length - 1]);
        if (lastSegment) {
          return lastSegment;
        }

        if (segments.length > 1) {
          const parentSegment = inspectSegment(segments[segments.length - 2]);
          if (parentSegment) {
            return parentSegment;
          }
        }

        return null;
      } catch (error) {
        debugWarn('Unable to resolve chart from path:', error);
        return null;
      }
    }

    function getBasePath() {
      const pathname = window.location.pathname || '/';
      const segments = pathname.split('/').filter(Boolean);

      if (!segments.length) {
        return '/';
      }

      const workingSegments = [...segments];

      const sanitizeSegment = (value) => (value || '').toLowerCase().replace(/\.html?$/, '');
      const isChartSegment = (segment) => {
        const normalized = normalizeChartId(sanitizeSegment(segment));
        return normalized ? ALL_CHART_IDS.has(normalized) : false;
      };

      const popIf = (predicate) => {
        if (!workingSegments.length) {
          return;
        }
        const candidate = workingSegments[workingSegments.length - 1];
        if (predicate(candidate)) {
          workingSegments.pop();
          popIf(predicate);
        }
      };

      popIf(segment => /\.[^/.]+$/.test(segment));
      popIf(segment => STATIC_CHART_IDS.has(sanitizeSegment(segment)));
      popIf(segment => isChartSegment(segment));

      if (!workingSegments.length) {
        return '/';
      }

      return '/' + workingSegments.join('/') + '/';
    }

    function getChartParam() {
      const pathChart = resolveChartFromPath();
      if (pathChart) {
        return pathChart;
      }
      const params = new URLSearchParams(window.location.search);
      const pageParam = normalizeChartId(params.get('page'));
      if (pageParam) {
        return pageParam;
      }
      return normalizeChartId(params.get('chart'));
    }

    function hasRequiredParams() {
      const params = new URLSearchParams(window.location.search);
      return params.has('pollutant_id');
    }

    function normalizeChartId(rawId) {
      if (!rawId) {
        return rawId;
      }

      const lower = String(rawId).toLowerCase();
      const mapping = {
        '1': 'bubblechart',
        'bubble': 'bubblechart',
        'bubblechart': 'bubblechart',
        '2': 'linechart',
        'line': 'linechart',
        'linechart': 'linechart',
        '3': 'category-info',
        'category-info': 'category-info',
        '4': 'user-guide',
        'user-guide': 'user-guide',
        '5': 'resources',
        'resources': 'resources'
      };

      return mapping[lower] || rawId;
    }

    function getDefaultUrl(chartId) {
      const basePath = getBasePath();
      const queryBase = basePath;

      const normalizedId = normalizeChartId(chartId) || 'bubblechart';

      if (normalizedId === 'bubblechart') {
        return `${queryBase}?page=bubblechart&pollutant_id=5&category_ids=20,37&year=2023`;
      }
      if (normalizedId === 'linechart') {
        return `${queryBase}?page=linechart&pollutant_id=5&category_ids=1&start_year=1970&end_year=2023`;
      }
      if (STATIC_CHART_IDS.has(normalizedId)) {
        return `${basePath}${normalizedId}`;
      }

      return `${queryBase}?page=bubblechart`;
    }

    function selectChart(chartId) {
      // Show loading indicator if present
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.classList.remove('hidden');
      }

      // Set default URL and load chart interface
      const defaultUrl = getDefaultUrl(chartId);
      updateHistoryState('replaceState', defaultUrl);

      setTimeout(async () => {
        await loadChartInterface(chartId);
      }, 500);
    }

    async function loadChartInterface(chartId) {
      try {
        console.log('Loading chart interface for chart', chartId);
        
        // Preload shared data 
        console.log('Priming default snapshot...');
        if (window.SharedDataLoader?.loadDefaultSnapshot) {
          window.SharedDataLoader.loadDefaultSnapshot().catch(error => {
            console.warn('Default snapshot preload failed:', error);
          });
        }
        
        // Simple delay to let everything initialize
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Reveal the interface
        await fadeToCompleteInterface(chartId);
        
        console.log('Chart interface loaded successfully');
      } catch (error) {
        console.error('Error loading chart interface:', error);
        
        // Fallback: show interface anyway
        const loadingEl = document.getElementById('loading');
        if (loadingEl) {
          loadingEl.classList.add('hidden');
        }

        const whiteOverlayEl = document.getElementById('white-overlay');
        if (whiteOverlayEl) {
          whiteOverlayEl.style.display = 'none';
        }

        document.getElementById('chart-interface').classList.remove('hidden');
        currentChart = normalizeChartId(chartId) || 'bubblechart';
        updateTabStates();
        showChart(currentChart);
      }
    }

    async function fadeToCompleteInterface(chartId) {
      console.log('Starting fade to complete interface');
      
      // Set the active chart
      currentChart = normalizeChartId(chartId) || 'bubblechart';
      
      // Ensure chart containers are ready
      const chartContainers = Array.from(document.querySelectorAll('.chart-container'));
      
      chartContainers.forEach(container => {
        container.style.display = 'block';
      });
      
      // Short delay to ensure positioning (v2.3 style)
      await new Promise(resolve => setTimeout(resolve, 250));
      
      // Start fade out of loading overlay and white overlay together
      const loading = document.getElementById('loading');
      const whiteOverlay = document.getElementById('white-overlay');

      if (loading) {
        loading.style.opacity = '0';
      }

      if (whiteOverlay) {
        whiteOverlay.style.opacity = '0';
      }
      
      // Reveal interface and charts simultaneously 
      requestAnimationFrame(() => {
        document.getElementById('chart-interface').classList.remove('hidden');
        updateTabStates();
        showChart(currentChart);
        
        // Mark charts as ready
        chartContainers.forEach(container => container.classList.add('ready'));
      });
      
      // Clean up after transition completes (v2.3 timing)
      setTimeout(() => {
        if (loading) {
          loading.classList.add('hidden');
        }

        if (whiteOverlay) {
          whiteOverlay.style.display = 'none';
        }
        console.log('Fade to complete interface finished');
      }, 400);
    }

    // Simplified chart loading - no complex coordination needed

    function hasParamsForChart(chartId, params) {
      if (!params) return false;
      if (chartId === 'bubblechart') {
        return ['pollutant_id', 'category_ids', 'year'].every(key => params.has(key) && params.get(key));
      }
      if (chartId === 'linechart') {
        return ['pollutant_id', 'category_ids', 'start_year', 'end_year'].every(key => params.has(key) && params.get(key));
      }
      return false;
    }

    function extractChartState(chartId, params) {
      if (!hasParamsForChart(chartId, params)) {
        return [];
      }
      if (chartId === 'bubblechart') {
        return [
          `pollutant_id=${params.get('pollutant_id')}`,
          `category_ids=${params.get('category_ids')}`,
          `year=${params.get('year')}`
        ];
      }
      if (chartId === 'linechart') {
        return [
          `pollutant_id=${params.get('pollutant_id')}`,
          `category_ids=${params.get('category_ids')}`,
          `start_year=${params.get('start_year')}`,
          `end_year=${params.get('end_year')}`
        ];
      }
      return [];
    }

    function switchChart(rawChartId) {
      const chartId = normalizeChartId(rawChartId) || 'bubblechart';
      const previousChart = currentChart;

      if (currentChart === chartId) return;

      const urlParams = new URLSearchParams(window.location.search);

      if ((!chartStates[chartId] || chartStates[chartId]?.length === 0) && hasParamsForChart(chartId, urlParams)) {
        chartStates[chartId] = extractChartState(chartId, urlParams);
      }

      const storedState = chartStates[chartId];
      const basePath = getBasePath();
      const queryBase = basePath;

      if (storedState && storedState.length > 0) {
        console.log('Using stored state for chart', chartId, storedState);
        const paramsArray = ['page=' + chartId, ...storedState];
        const newQuery = paramsArray.join('&');
        const newUrl = `${queryBase}?${newQuery}`;
        const historyMethod = currentChart ? 'pushState' : 'replaceState';

        const canonicalParam = normalizeChartId(urlParams.get('page')) || normalizeChartId(urlParams.get('chart'));
        if (window.location.search.substring(1) !== newQuery || canonicalParam !== chartId) {
          updateHistoryState(historyMethod, newUrl);
        }
      } else {
        console.log('No stored state for chart', chartId, '- using defaults');

        const historyMethod = currentChart ? 'pushState' : 'replaceState';
        let newUrl = null;

        if (chartId === 'bubblechart' || chartId === 'linechart') {
          const newParams = new URLSearchParams();
          newParams.set('page', chartId);

          if (chartId === 'bubblechart') {
            newParams.set('pollutant_id', '5');
            newParams.set('category_ids', '20,37');
            newParams.set('year', '2023');
            chartStates.bubblechart = ['pollutant_id=5', 'category_ids=20,37', 'year=2023'];
          } else if (chartId === 'linechart') {
            newParams.set('pollutant_id', '5');
            newParams.set('category_ids', '1');
            newParams.set('start_year', '1970');
            newParams.set('end_year', '2023');
            chartStates.linechart = ['pollutant_id=5', 'category_ids=1', 'start_year=1970', 'end_year=2023'];
          }

          const paramsArray = [];
          for (const [key, value] of newParams) {
            if (key === 'category_ids' || key === 'start_year' || key === 'end_year' || key === 'year') {
              paramsArray.push(`${key}=${value}`);
            } else {
              paramsArray.push(`${key}=${encodeURIComponent(value)}`);
            }
          }

          const newQuery = paramsArray.join('&');
          newUrl = `${queryBase}?${newQuery}`;
        } else if (STATIC_CHART_IDS.has(chartId)) {
          newUrl = `${basePath}${chartId}`;
          chartStates[chartId] = [];
        }

        if (newUrl) {
          updateHistoryState(historyMethod, newUrl);
        }
      }

      currentChart = chartId;
      updateTabStates();
      showChart(chartId);
      notifyIframeVisibility(chartId, true);
      if (previousChart && previousChart !== chartId) {
        notifyIframeVisibility(previousChart, false);
      }

    }

    function updateTabStates() {
      // Update tab appearance
      const baseClasses = 'py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2';
      const activeClasses = `${baseClasses} tab-active`;
      const inactiveClasses = `${baseClasses} border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300`;

      document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        const tabChart = normalizeChartId(tab.dataset.chart);
        if (!tabChart) {
          return;
        }
        const isActive = tabChart === currentChart;
        tab.className = isActive ? activeClasses : inactiveClasses;
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        tab.tabIndex = isActive ? 0 : -1;
      });
    }

    function focusTab(chartId) {
      const normalizedId = normalizeChartId(chartId) || 'bubblechart';
      const tabId = TAB_ID_MAP[normalizedId];
      if (!tabId) {
        return;
      }
      const tabElement = document.getElementById(tabId);
      if (!tabElement) {
        return;
      }

      try {
        tabElement.focus({ preventScroll: true });
      } catch (error) {
        tabElement.focus();
      }
    }

    function showChart(chartId) {
      // Use visibility to allow both charts to render, but only show one
      document.querySelectorAll('.chart-container').forEach(container => {
        container.style.visibility = 'hidden';
        container.style.height = '0';
        container.style.overflow = 'hidden';
        container.setAttribute('aria-hidden', 'true');
      });
      
      const normalizedId = normalizeChartId(chartId) || 'bubblechart';
      const chartContainer = document.getElementById(`chart-${normalizedId}`);
      if (!chartContainer) {
        debugWarn('Unable to locate chart container for', normalizedId);
        return;
      }
      chartContainer.style.visibility = 'visible';
      chartContainer.style.height = 'auto';
      chartContainer.style.overflow = 'visible';
      chartContainer.setAttribute('aria-hidden', 'false');
      loadLazyIframeForChart(normalizedId);
    }

    function loadLazyIframeForChart(chartId) {
      const container = document.getElementById(`chart-${chartId}`);
      if (!container) {
        return;
      }
      const iframe = container.querySelector('iframe[data-src]');
      if (!iframe) {
        return;
      }
      const src = iframe.dataset.src;
      if (!src) {
        return;
      }
      iframe.src = src;
      try {
        iframe.loading = 'eager';
      } catch (error) {
        /* noop */
      }
      iframe.dataset.loaded = 'true';
      iframe.removeAttribute('data-src');
    }

    const PREPAINT_CHARTS = ['category-info', 'user-guide', 'resources'];

    function prepaintHiddenChart(chartId) {
      const container = document.getElementById(`chart-${chartId}`);
      if (!container || container.dataset.prepainted === 'true') {
        return;
      }

      const iframe = container.querySelector('iframe');
      if (!iframe) {
        return;
      }

      loadLazyIframeForChart(chartId);

      const previousState = {
        visibility: container.style.visibility,
        height: container.style.height,
        overflow: container.style.overflow,
        ariaHidden: container.getAttribute('aria-hidden')
      };

      container.style.visibility = 'visible';
      container.style.height = 'auto';
      container.style.overflow = 'visible';
      container.style.opacity = '0';
      container.style.pointerEvents = 'none';
      container.setAttribute('aria-hidden', 'true');

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          if (container.getAttribute('aria-hidden') === 'false') {
            container.style.opacity = '';
            container.style.pointerEvents = '';
            container.dataset.prepainted = 'true';
            return;
          }

          container.style.visibility = previousState.visibility || 'hidden';
          container.style.height = previousState.height || '0';
          container.style.overflow = previousState.overflow || 'hidden';
          container.style.opacity = '';
          container.style.pointerEvents = '';

          if (previousState.ariaHidden !== null && previousState.ariaHidden !== undefined) {
            container.setAttribute('aria-hidden', previousState.ariaHidden);
          } else {
            container.removeAttribute('aria-hidden');
          }

          container.dataset.prepainted = 'true';
        });
      });
    }

    function prepaintSupplementalCharts() {
      PREPAINT_CHARTS.forEach(prepaintHiddenChart);
    }

    function navigateChartByDelta(delta) {
      if (!currentChart || !Number.isFinite(delta) || delta === 0) {
        return null;
      }

      const normalizedCurrent = normalizeChartId(currentChart) || 'bubblechart';
      const currentIndex = CHART_SEQUENCE.indexOf(normalizedCurrent);
      if (currentIndex === -1) {
        return null;
      }

      const nextIndex = (currentIndex + delta + CHART_SEQUENCE.length) % CHART_SEQUENCE.length;
      const nextChartId = CHART_SEQUENCE[nextIndex];

      if (nextChartId === normalizedCurrent) {
        return null;
      }

      switchChart(nextChartId);
      return nextChartId;
    }

    function handleTabKeyboardNavigation(event) {
      if (event.defaultPrevented) {
        return;
      }

      if (event.metaKey || event.ctrlKey || event.altKey) {
        return;
      }

      if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
        return;
      }

      const activeElement = document.activeElement;
      if (activeElement && (activeElement.isContentEditable || ['input', 'textarea', 'select'].includes(activeElement.tagName.toLowerCase()))) {
        return;
      }

      event.preventDefault();

      const preservedScrollX = window.scrollX;
      const preservedScrollY = window.scrollY;
      const delta = event.key === 'ArrowRight' ? 1 : -1;
      const nextChartId = navigateChartByDelta(delta);

      if (!nextChartId) {
        return;
      }

      requestAnimationFrame(() => {
        window.scrollTo({ top: preservedScrollY, left: preservedScrollX });
        focusTab(nextChartId);
      });
    }


    // Simplified initialization for iframe-based charts
    
    // Simple loading overlay control - MESSAGE BASED APPROACH
    let overlayHidden = false;
    const heightsReceived = { bubblechart: false, linechart: false, 'category-info': false, 'user-guide': false };
    const OVERLAY_FAILSAFE_DELAY_MS = 12000;
    let overlayFailsafeTimer = null;
    
    // Set initial reasonable height estimate
    const lineIframe = iframeElements.linechart;
    if (lineIframe) {
      lineIframe.style.height = '1200px'; // Initial estimate
    }

    const bubbleIframe = iframeElements.bubblechart;
    if (bubbleIframe) {
      bubbleIframe.style.height = '1100px';
    }

    const categoryInfoIframe = iframeElements['category-info'];
    if (categoryInfoIframe) {
      categoryInfoIframe.style.height = '1000px';
    }

    const userGuideIframe = iframeElements['user-guide'];
    if (userGuideIframe) {
      userGuideIframe.style.height = '1000px';
    }

    const resourcesIframe = iframeElements.resources;
    if (resourcesIframe) {
      resourcesIframe.style.height = '800px';
    }
    
    // Defer iframe message processing until helper functions are available
    function processIframeMessage(event) {

      if (event.data && event.data.type === 'requestChartNavigation') {
        const direction = event.data.direction === 'previous' ? -1 : 1;
        const preservedScrollX = window.scrollX;
        const preservedScrollY = window.scrollY;
        const nextChartId = navigateChartByDelta(direction);

        if (!nextChartId) {
          return;
        }

        requestAnimationFrame(() => {
          window.scrollTo({ top: preservedScrollY, left: preservedScrollX });
          focusTab(nextChartId);
        });
        return;
      }

      if (event.data && event.data.type === 'scrollToBubbleTutorial') {
        const requestId = event.data.requestId;
        const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const bubbleContainer = document.getElementById('chart-bubblechart') || document.getElementById('bubblechart-iframe');
        const headerOffset = 32;
        const scrollTarget = bubbleContainer;

        let scrolled = false;
        if (scrollTarget) {
          const rect = scrollTarget.getBoundingClientRect();
          const pageOffset = window.pageYOffset || document.documentElement.scrollTop || 0;
          const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
          const containerHeight = rect.height || scrollTarget.offsetHeight || 0;
          const centerOffset = Math.max(0, (viewportHeight - containerHeight) / 2);
          const targetTop = Math.max(0, rect.top + pageOffset - centerOffset - headerOffset);
          const currentTop = window.pageYOffset || document.documentElement.scrollTop || 0;
          if (Math.abs(currentTop - targetTop) > 4) {
            window.scrollTo({ top: targetTop, behavior: prefersReducedMotion ? 'auto' : 'smooth' });
            scrolled = true;
          }
        }

        const acknowledge = () => {
          try {
            if (event.source && typeof event.source.postMessage === 'function') {
              event.source.postMessage({ type: 'bubbleTutorialScrollComplete', requestId }, '*');
            }
          } catch (error) {
            console.warn('Unable to acknowledge bubble tutorial scroll:', error);
          }
        };

        if (prefersReducedMotion || !scrolled) {
          acknowledge();
        } else {
          setTimeout(acknowledge, 200);
        }
        return;
      }

      // Handle URL updates from iframes
      if (event.data && event.data.type === 'updateUrl') {
        updateHistoryState('replaceState', event.data.url);
      }

      if (event.data && event.data.type === 'requestParentViewportMetrics') {
        const chartKey = normalizeChartId(event.data.chart) || event.data.chart;
        getParentFooterHeight();
        broadcastViewportMetrics(chartKey);
        return;
      }

      if (event.data && event.data.type === 'bubbleTutorialState') {
        if (event.data.state === 'opened') {
          bubbleTutorialControl.openRequestSent = true;

          if (!bubbleTutorialControl.active) {
            bubbleTutorialControl.active = true;
            bubbleTutorialControl.requested = false;
            const currentUrl = window.location.pathname + window.location.search + window.location.hash;
            updateHistoryState('replaceState', currentUrl);
          }

          if (window.history && 'scrollRestoration' in window.history) {
            window.history.scrollRestoration = 'manual';
          }
        } else if (event.data.state === 'closed' && bubbleTutorialControl.active) {
          bubbleTutorialControl.active = false;
          bubbleTutorialControl.requested = false;
          bubbleTutorialControl.openRequestSent = false;
          removeBubbleTutorialFlagFromUrl();

          if (window.history && 'scrollRestoration' in window.history) {
            window.history.scrollRestoration = 'auto';
          }
        }
        return;
      }
      
      if (event.data && event.data.type === 'chartReady' && !overlayHidden) {
        const rawChartKey = event.data.chart;
        const chartKey = normalizeChartId(rawChartKey) || rawChartKey;
        const keyLabel = typeof chartKey === 'string'
          ? chartKey.charAt(0).toUpperCase() + chartKey.slice(1)
          : 'Unknown';
        
        if (chartReadyState.hasOwnProperty(chartKey)) {
          chartReadyState[chartKey] = true;
        } else {
          debugWarn('⚠️ Unknown chart reported ready:', rawChartKey);
        }

        requestSharedDataBootstrap(`chartReady:${chartKey}`);

        if (chartKey === 'bubblechart') {
          attemptBubbleTutorialAutoOpen();
        }

        if (areAllChartsReady()) {
          Object.entries(iframeElements).forEach(([key, iframe]) => {
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage({ type: 'requestHeight' }, '*');
            }
          });
        }
      }

      // Handle content height from iframe (sent once after initial render)
      if (event.data && event.data.type === 'contentHeight') {
        const rawChartKey = event.data.chart;
        const chartKey = normalizeChartId(rawChartKey) || rawChartKey;
        const iframe = iframeElements[chartKey];
        
        if (iframe) {
          const reportedHeight = Number(event.data.height);
          const fallbackHeight = 900;
          const safeHeight = Number.isFinite(reportedHeight) && reportedHeight > 0
            ? reportedHeight
            : fallbackHeight;

          let finalHeight = safeHeight;

          if (!Number.isFinite(reportedHeight) || reportedHeight <= 0) {
            debugWarn(`⚠️ Received invalid height (${event.data.height}) from ${chartKey}; using fallback ${safeHeight}px`);
          }

          iframe.style.height = finalHeight + 'px';
          if (chartKey === 'bubblechart' || chartKey === 'linechart' || chartKey === 'user-guide') {
            getParentFooterHeight();
            broadcastViewportMetrics(chartKey);
          }
          
          heightsReceived[chartKey] = true;

          maybeHideOverlay();
        }
      }
      
      // Debug messages from iframes
      if (event.data && event.data.type === 'debug') {
      }
      
      // URL update messages from iframe
      if (event.data && event.data.type === 'updateURL') {
        const iframeEntry = Object.entries(iframeElements).find(([, iframe]) => iframe && iframe.contentWindow === event.source);
        let chartKey = null;

        if (iframeEntry) {
          const sourceKey = iframeEntry[0];
          if (sourceKey === 'bubble') {
            chartKey = 'bubblechart';
          } else if (sourceKey === 'line') {
            chartKey = 'linechart';
          } else {
            chartKey = normalizeChartId(sourceKey) || null;
          }
        }

        if (!chartKey) {
          const fallbackParams = new URLSearchParams(window.location.search);
          const fallbackParam = normalizeChartId(fallbackParams.get('page')) || normalizeChartId(fallbackParams.get('chart'));
          chartKey = fallbackParam || currentChart || 'bubblechart';
        }

        const paramsArray = Array.isArray(event.data.params) ? event.data.params : [];
        if (!paramsArray.length) {
          return;
        }

        const paramsSearch = new URLSearchParams(paramsArray.join('&'));
        const messageChart = normalizeChartId(event.data.chart) || normalizeChartId(paramsSearch.get('page')) || normalizeChartId(paramsSearch.get('chart'));
        if (messageChart && messageChart !== chartKey) {
          return;
        }

        const sanitizedState = [];
        paramsSearch.forEach((value, key) => {
          if (key === 'page' || key === 'chart') {
            return;
          }
          sanitizedState.push(`${key}=${value}`);
        });
        chartStates[chartKey] = sanitizedState;

        if (currentChart !== chartKey) {
          return;
        }

        paramsSearch.delete('chart');
        paramsSearch.set('page', chartKey);
        const serialized = [`page=${chartKey}`];
        paramsSearch.forEach((value, key) => {
          if (key === 'page') {
            return;
          }
          serialized.push(`${key}=${value}`);
        });
        const basePath = getBasePath();
        const newUrl = `${basePath}?${serialized.join('&')}`;

        updateHistoryState('replaceState', newUrl);
      }
      
      // Line debug messages
      if (event.data && event.data.type === 'lineDebug') {
      }
    }

    window.__NAEI_processIframeMessage = processIframeMessage;
    if (Array.isArray(window.__NAEI_messageQueue) && window.__NAEI_messageQueue.length) {
      const pendingMessages = window.__NAEI_messageQueue.splice(0);
      pendingMessages.forEach(event => {
        try {
          processIframeMessage(event);
        } catch (error) {
          console.warn('Deferred iframe message failed:', error);
        }
      });
    }
    
    // Hide loading overlay function - make it global for iframe onload
    window.hideLoadingOverlay = function() {
      if (overlayHidden) {
        return;
      }
      overlayHidden = true;

      if (overlayFailsafeTimer) {
        clearTimeout(overlayFailsafeTimer);
        overlayFailsafeTimer = null;
      }
      
      const overlay = document.getElementById('main-loading-overlay');
      const chartInterface = document.getElementById('chart-interface');
      
      if (chartInterface) {
        // Make chart interface visible instantly (no transition)
        // The overlay fade will handle the visual reveal
        chartInterface.style.opacity = '1';
      }
      
      if (overlay) {
        overlay.style.opacity = '0';
        
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          
          // Notify iframes that overlay is fully hidden and they can respond to resizes
          Object.values(iframeElements).forEach(iframe => {
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage({ type: 'overlayHidden' }, '*');
            }
          });
          
        }, 500);
      }
    };
    
    // Initialize when DOM ready
    window.addEventListener('DOMContentLoaded', function() {
      console.log('Main page DOM loaded');
      const pathChart = resolveChartFromPath();
      const urlParams = new URLSearchParams(window.location.search);
      let chartParam = pathChart || urlParams.get('page') || urlParams.get('chart') || 'bubblechart';

      if (bubbleTutorialControl.requested) {
        chartParam = 'bubblechart';
      }

      chartParam = normalizeChartId(chartParam) || 'bubblechart';
      setOverlayRequiredCharts(chartParam);
      console.log('Initial chart selection:', chartParam);
      switchChart(chartParam);

      if (!overlayFailsafeTimer) {
        overlayFailsafeTimer = setTimeout(() => {
          console.warn('Overlay failsafe triggered after waiting for initial charts to report ready state.');
          window.hideLoadingOverlay();
        }, OVERLAY_FAILSAFE_DELAY_MS);
      }

      document.addEventListener('keydown', handleTabKeyboardNavigation);
      
    // Comprehensive iframe debugging
    const lineIframe = iframeElements.linechart;
    const bubbleIframe = iframeElements.bubblechart;
      
      if (lineIframe) {
        if (debugLoggingEnabled) {
          console.log('Line chart iframe found, src:', lineIframe.src);

          lineIframe.addEventListener('load', () => {
            console.log('Line chart iframe loaded event fired');
            console.log('⏰ Waiting for chartReady message from iframe...');

            // Debug iframe script execution
            setTimeout(() => {
              console.log('🔍 Checking if iframe scripts loaded...');
              try {
                const iframeDoc = lineIframe.contentDocument || lineIframe.contentWindow.document;
                console.log('🔍 Iframe document readyState:', iframeDoc.readyState);
                console.log('🔍 Iframe body exists:', !!iframeDoc.body);

                // Check if scripts are present
                const scripts = iframeDoc.querySelectorAll('script');
                console.log('🔍 Number of scripts found in iframe:', scripts.length);

                if (scripts.length === 0) {
                  console.log('⚠️ NO SCRIPTS IN IFRAME - This is abnormal!');
                  console.log('🔍 Checking iframe HTML source...');
                  console.log('🔍 First 500 chars of iframe HTML:', iframeDoc.documentElement.innerHTML.substring(0, 500));

                  // The iframe HTML is not loading scripts - possible iframe security issue
                  // Let's force a reload
                  console.log('🔄 Attempting iframe reload...');
                  lineIframe.src = lineIframe.src; // Force reload
                } else {
                  // List script details
                  scripts.forEach((script, index) => {
                    console.log(`🔍 Script ${index + 1}:`, {
                      src: script.src || 'inline',
                      hasContent: !!script.textContent.trim(),
                      type: script.type || 'text/javascript'
                    });
                  });
                }

              } catch (e) {
                console.log('🔍 Cannot access iframe document (security restrictions):', e.message);
              }
            }, 1000);
          });
        }

        lineIframe.addEventListener('error', (e) => {
          console.error('Line chart iframe error:', e);
          // Hide overlay even on error
          setTimeout(() => {
            console.log('Error: Hiding overlay due to iframe error');
            hideLoadingOverlay();
          }, 2000);
        });
      }
      
      if (bubbleIframe && debugLoggingEnabled) {
        console.log('Bubble chart iframe found, src:', bubbleIframe.src);
        bubbleIframe.addEventListener('load', () => {
          console.log('Bubble chart iframe loaded');
        });
      }
    });
  </script>
</body>
</html>